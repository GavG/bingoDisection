<html>

<head>

    <style>
        body {
            background: red;
        }
        img {
            margin: 1px;
        }
        p {
            white-space: nowrap;
            margin-right: 10px;
        }
    </style>

</head>

<body>

    <canvas id='c' style='display: none;' height=10 width=20></canvas>

    <script src='https://unpkg.com/tesseract.js@2.0.2/dist/tesseract.min.js'></script>

    <script>

        const worker = Tesseract.createWorker();

        var cellWidth = 31.9
        var cellHeight = 31.6
        var cellBorderWidth = 0

        var cellStartPadding = 2
        var cellEndPadding = 2

        var cellBorderHeight = 6

        var image = new Image(258, 665),
            canvas = document.createElement('canvas'),
            ctx = canvas.getContext('2d')

        canvas.width = cellWidth
        canvas.height = cellHeight

        var topCardY = 88
        var cardGapY = 18.7

        var cardOffsetX = 6

        var cards = {
            card1: {
                offsetY: topCardY,
                cells: [],
            },

            card2: {
                offsetY: topCardY + cardGapY + (cellHeight * 3),
                cells: [],
            },

            card3: {
                offsetY: topCardY + (cardGapY * 2) + (cellHeight * 6),
                cells: [],
            },

            card4: {
                offsetY: topCardY + (cardGapY * 3) + (cellHeight * 9),
                cells: [],
            },

            card5: {
                offsetY: topCardY + (cardGapY * 4) + (cellHeight * 12),
                cells: [],
            },

            card6: {
                offsetY: topCardY + (cardGapY * 5) + (cellHeight * 15),
                cells: [],
            }
        }


        image.addEventListener('load', processCards)

        image.src = 'http://127.0.0.1:5500/m.png'

        async function processCards() {
            
            await worker.load();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            await worker.setParameters({
                tessedit_char_whitelist: "0123456789",
            });

            let cardNo = 0

            for (var cardId in cards) {
                let card = cards[cardId]

                let h = document.createElement('h1')
                h.textContent = cardId
                document.body.append(h)

                let d = document.createElement('div')
                d.style.display = 'flex'
                document.body.append(d)

                //Rows
                for (var r = 0; r < 3; r++) {
                    let cellOffsetY = (cellHeight * r) - cellBorderHeight

                    //Cells
                    for (var c = 0; c < 9; c++) {
                        let cellOffsetX = (cellWidth + cellBorderWidth) * c
                        ctx.drawImage(image, cardOffsetX + cellOffsetX + cellStartPadding, card.offsetY + cellOffsetY + cellBorderHeight, cellWidth - cellEndPadding, cellHeight - cellBorderHeight, 0, 0, cellWidth, cellHeight)

                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)

                        let data = imageData.data

                        let cellImg = new Image()

                        let imgSrc = canvas.toDataURL()

                        cellImg.src = imgSrc

                        let res = await recognize(canvas)

                        if(res){
                            d.parentNode.insertBefore(cellImg, d)

                            let p = document.createElement('p')

                            p.innerHTML = `${res}:[${(9 * 3 * cardNo) + (r * 9) + c}]`

                            d.append(p)
                        }

                    }

                    d = document.createElement('div')
                    d.style.display = 'flex'
                    document.body.append(d)

                }

                document.body.append(document.createElement('br'))

                cardNo += 1

            }

        }

        async function recognize(img) {
            result = await worker.recognize(img);    
            return result.data.text
        }

    </script>

</body>

</html>